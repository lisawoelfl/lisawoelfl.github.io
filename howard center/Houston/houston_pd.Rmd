---
title: "houston_pd"
output: html_notebook
---

## Introduction 

In this notebook, I'm examining call data from the Houston police department. The data spans from beginning of 2017 to end of 2022. The data is prefiltered by HPD for family violence related calls, although other calls are in the data as well.

I'm examining the data on family violence around Hurricane Harvey (Aug. 23 -  Sept. 17 2017) and Winter Storm Uri (Feb. 13 - 17 2021).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
``` 

## Load libraries

Loading required libraries for this analysis.

```{r}
library(tidyverse)
library(janitor)
library(lubridate)
library(stringr)
library(dplyr)
library(tidyr)
library(readxl)
library(xlsx)
library(forecast)
library(ggplot2)
library(zoo)
```
## Reading, preparing and cleaning the data

```{r}
## read and combine all files

x1 <- "excels/woefl1.xlsx" %>%
  read_excel(sheet = 1) %>% clean_names()
x2 <- "excels/woefl2.xlsx" %>%
  read_excel(sheet = 1) %>%
  set_names(x2 <- c("incident", "date", "offense_type", "premise")) %>% 
  clean_names()
x3 <- "excels/woefl3.xlsx" %>%
  read_excel(sheet = 1) %>% 
  set_names(x3 <- c("incident", "date", "offense_type", "premise")) %>% clean_names()
x4 <- "excels/woefl4.xlsx" %>%
  read_excel(sheet = 1) %>% 
  set_names(x4 <- c("incident", "date", "offense_type", "premise")) %>% clean_names()
x5 <- "excels/woefl5.xlsx" %>%
  read_excel(sheet = 1) %>% 
  set_names(x5 <- c("incident", "date", "offense_type", "premise")) %>% clean_names()
x6 <- "excels/woefl6.xlsx" %>%
  read_excel(sheet = 1) %>% 
  set_names(x6 <- c("incident", "date", "offense_type", "premise")) %>% clean_names()
x7 <- "excels/woefl7.xlsx" %>%
  read_excel(sheet = 1) %>% 
  set_names(x7 <- c("incident", "date", "offense_type", "premise")) %>% clean_names()

houston_cfs <- bind_rows(x1, x2, x3, x4, x5, x6, x7) %>% 
    mutate(date = as.Date(date, format = "%Y-%m-%d"))


## see offense types -> not just family violence, but other offenses as well

offense_type <- houston_cfs %>% 
  count(offense_type) %>% 
  arrange(desc(n))

## filtering for all offenses that indicated family violence

houston_fv <- houston_cfs %>% 
  filter(grepl('Fam Viol|Family Violence|FamViol|FamViolence|Fam Member', offense_type)) %>% 
  filter(!grepl('NotFamViol', offense_type)) %>% 
  mutate(year = as.numeric(format(date, '%Y'))) %>% 
  mutate(month =as.numeric(format(date, '%m'))) %>% 
  mutate(day = as.numeric(format(date, '%d')))

## count daily occurences of family violence calls

fv_day <- houston_fv %>% 
  mutate(date = floor_date(date, "day")) %>% 
  count(date)

write_csv(fv_day, "family_violence_calls_daily.csv")

## count daily occurrences of family violence calls in 2021

fv_2021 <- houston_fv %>% 
  mutate(date = floor_date(date, "day")) %>% 
  filter(grepl('^2021', date)) %>% 
  count(date)

write_csv(fv_2021, "family_violence_calls_2021.csv")
```


```{r}
## apply rolling average, 7 days

fv_day_average <- fv_day %>% 
  mutate(rolling_avg = rollmean(n, k=7, fill=NA, align='right'))

write_csv(fv_day_average, "fv_calls_average.csv")

## rolling average 7 days just for 2021

fv_2021_average <- fv_2021 %>% 
  mutate(rolling_avg = rollmean(n, k=7, fill=NA, align='right'))

write_csv(fv_2021_average, "fv_2021_average.csv")
```

## Testing significance

```{r}
## welch 2 sample t-test, uri, feb 2021 vs all other months

feb_2021 <- fv_day %>% 
  filter(grepl('^2021-02', date))

mean_feb_2021 <- mean(feb_2021$n)
sd_feb_2021 <- sd(feb_2021$n)

## mean: 80.39285714
## sd: 16.5537044

other_months <- fv_day %>% 
  filter(!grepl('^2021-02', date))

mean_other_months <-mean(other_months$n)
sd_other_months <- sd(other_months$n)

t_test_result <- t.test(feb_2021$n, other_months$n)

print(t_test_result)  

## t-test, uri, feb 2021 vs all other febs

other_febs <- fv_day %>% 
  filter(grepl('^2022-02|^2020-02|^2019-02|^2018-02|^2017-02', date))

mean_other_febs <- mean(other_febs$n)
sd_other_febs <- sd(other_febs$n)

t_test_result_2 <- t.test(feb_2021$n, other_febs$n)
print(t_test_result_2)

## filter data for just febs

all_febs_year <- houston_fv %>% 
  filter(month == 2) %>% 
  count(year)

all_febs <- fv_day %>% 
  filter(grepl('^2022-02|^2021-02|^2020-02|^2019-02|^2018-02|^2017-02', date))

write_csv(all_febs, "all_febs.csv")

## rolling average for 2017/harvey

fv_2017_average <- houston_fv %>%
  filter(year == 2017) %>% 
  count(date) %>% 
  mutate(rolling_avg = rollmean(n, k=7, fill=NA, align='right'))

write_csv(fv_2017_average, "fv_2017_average.csv")

## t-test for harvey, august & september

augsep_2017 <- fv_day %>% 
  filter(grepl('^2017-08|^2017-09', date))

mean_augsep_2017 <- mean(augsep_2017$n)
sd_augsep_2017 <- sd(augsep_2017$n)

other_months_2 <- fv_day %>% 
  filter(!grepl('^2017-08|^2017-09', date))

mean_other_months_2 <-mean(other_months_2$n)
sd_other_months_2 <- sd(other_months_2$n)

t_test_result_3 <- t.test(augsep_2017$n, other_months_2$n)

print(t_test_result_3)

## t-test with just augsep, harvey

other_augseps <- fv_day %>% 
  filter(grepl('^2022-08|^2022-09|^2021-08|^2021-09|^2020-08|^2020-09|^2019-08|^2019-09|^2018-08|^2018-09', date))

mean_other_augseps <- mean(other_augseps$n)
sd_other_augsepts <- sd(other_augseps$n)

t_test_result_4 <- t.test(augsep_2017$n, other_augseps$n)
print(t_test_result_4)

## look at violations of protective orders

po <- houston_cfs %>% 
  filter(grepl("Protective Order", offense_type)) %>% 
  mutate(date = floor_date(date, "month")) %>% 
  count(date)

write_csv(po, "violations_protective_orders.csv")

```

## Calculating averages for Harvey

```{r}
## average calls per day for harvey fema incident period

incident_period <- fv_day %>% 
  filter(grepl('2017-08-23|2017-08-24|2017-08-25|2017-08-26|2017-08-27|2017-08-28|2017-08-29|2017-08-30|2017-08-31|2017-09-01|2017-09-02|2017-09-03|2017-09-04|2017-09-05|2017-09-06|2017-09-07|2017-09-08|2017-09-09|2017-09-10|2017-09-11|2017-09-12|2017-09-13|2017-09-14|2017-09-15', date))

mean_incident_period <- mean(incident_period$n)
print(mean_incident_period)

##average for the same period in other years

non_incident_period <- fv_day %>% 
  filter(grepl('08-23$|08-24$|08-25$|08-26$|08-27$|08-28$|08-29$|08-30$|08-31$|09-01$|09-02$|09-03$|09-04$|09-05$|09-06$|09-07$|09-08$|09-09$|09-10$|09-11$|09-12$|09-13$|09-14$|09-15$',date)) %>% 
  filter(!grepl('2017-08-23|2017-08-24|2017-08-25|2017-08-26|2017-08-27|2017-08-28|2017-08-29|2017-08-30|2017-08-31|2017-09-01|2017-09-02|2017-09-03|2017-09-04|2017-09-05|2017-09-06|2017-09-07|2017-09-08|2017-09-09|2017-09-10|2017-09-11|2017-09-12|2017-09-13|2017-09-14|2017-09-15', date))

mean_non_incident_period <- mean(non_incident_period$n)
print(mean_non_incident_period)
print(non_incident_period)

```

Analysis: 

## Harvey

Harvey impacted Texas from August 25 to 29, according to the National Weather Service. FEMA states the incident period from Aug. 23 to Sept. 15.

Average call per day during FEMA's incident period was 61 calls. In the same period in the following five years, it was 80 daily calls on average.

August 27, 2017 has the lowest recorded call volume related to family violence, only 14 calls reached Houston PD. The average number of daily calls Aug-Sep in 2017 was 65.6 compared to all other months (74.7) and all other Aug-Sep (78).

Looking at yearly aggregate data, we find that in the examined time period August-September had the lowest number of calls in 2017 (2001) and the highest call volume in 2021 (2537).

## Uri

To the naked eye, February 2021, when winter storm Uri hit and left millions without power, there weren't any glaring changes in call volume related to family violence to the Houston police department. Looking at the average call numbers, however, reveals that in Feb 2021, a mean of 80.4 daily calls reached the police. Comparatively, all other months had an average of 74.4 daily calls. All other Februaries had 67.8. This alone shows that February is usually a low call volume month. A t-test showed that the result was significant when comparing only Februaries (p = 0.0007).

The yearly call volumes show that 2021 was the busiest year in February (2251), while the police received the least calls in Feb 2017 (1690).